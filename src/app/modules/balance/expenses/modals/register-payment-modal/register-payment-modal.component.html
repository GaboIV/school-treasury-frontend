<div class="modal-header">
  <h4 class="modal-title">Registrar Pago</h4>
  <button type="button" class="btn-close" aria-label="Close" (click)="activeModal.dismiss()"></button>
</div>

<form [formGroup]="paymentForm" (ngSubmit)="save()">
  <div class="modal-body">
    <div *ngIf="error" class="alert alert-danger">
      {{ error }}
    </div>

    <div class="mb-4">
      <h5>Información del Pago</h5>
      <div class="d-flex flex-column">
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Estudiante:</span>
          <span class="fw-bold">{{ payment.studentName }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Gasto:</span>
          <span class="fw-bold">{{ payment.expenseName }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Monto a Pagar:</span>
          <span class="fw-bold">{{ payment.amountExpense | currency: 'S/ ' }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Monto Pagado:</span>
          <span class="fw-bold">{{ payment.amountPaid | currency: 'S/ ' }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Pendiente:</span>
          <span class="fw-bold text-danger">{{ payment.pending | currency: 'S/ ' }}</span>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label required">Monto a Pagar</label>
      <input
        type="number"
        class="form-control"
        formControlName="amountPaid"
        [ngClass]="{
          'is-invalid': isControlInvalid('amountPaid'),
          'is-valid': isControlValid('amountPaid')
        }"
      />
      <div class="invalid-feedback" *ngIf="controlHasError('required', 'amountPaid')">
        El monto es requerido
      </div>
      <div class="invalid-feedback" *ngIf="controlHasError('min', 'amountPaid')">
        El monto debe ser mayor a 0
      </div>
      <div class="invalid-feedback" *ngIf="controlHasError('max', 'amountPaid')">
        El monto no puede ser mayor al pendiente ({{ payment.pending | currency: 'S/ ' }})
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Comentario (opcional)</label>
      <textarea
        class="form-control"
        formControlName="comment"
        rows="3"
      ></textarea>
    </div>

    <!-- Sección de carga de imágenes -->
    <div class="mb-3">
      <label class="form-label">Imágenes de comprobante (opcional)</label>

      <!-- Área de arrastrar y soltar -->
      <div
        class="border rounded p-3 text-center mb-2"
        [ngClass]="{'bg-light border-primary': isDragging}"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
      >
        <div class="py-3">
          <i class="bi bi-cloud-upload fs-1 text-primary"></i>
          <p class="mb-0 mt-2">Arrastra y suelta imágenes aquí</p>
          <p class="text-muted small">o</p>
          <label class="btn btn-outline-primary btn-sm">
            <span>Seleccionar archivos</span>
            <input type="file" class="d-none" accept="image/*" multiple (change)="onFileSelected($event)">
          </label>
          <p class="text-muted small mt-2">Tamaño máximo: 5MB por imagen</p>
        </div>
      </div>

      <!-- Previsualización de imágenes -->
      <div class="row g-2 mt-2" *ngIf="imagePreviewUrls.length > 0">
        <div class="col-4 col-md-3 col-lg-2" *ngFor="let imageUrl of imagePreviewUrls; let i = index">
          <div class="position-relative">
            <img [src]="imageUrl" class="img-thumbnail" alt="Imagen previa">
            <button
              type="button"
              class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle"
              style="margin-top: -10px; margin-right: -10px; width: 24px; height: 24px; padding: 0;"
              (click)="removeImage(i)"
            >
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-light" (click)="activeModal.dismiss()">Cancelar</button>
    <button
      type="submit"
      class="btn btn-primary"
      [disabled]="paymentForm.invalid || isLoading"
    >
      <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      Registrar Pago
    </button>
  </div>
</form>
